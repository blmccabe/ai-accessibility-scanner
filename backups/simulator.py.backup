# simulator.py (Custom demo with formatted text, TTS audio, and CTA)
import json
import logging
import os
import tempfile
from openai import OpenAI
import streamlit as st
import time
from bs4 import BeautifulSoup
from gtts import gTTS
import io

logging.basicConfig(level=logging.INFO)

def load_personas():
    try:
        with open("simulator/personas.json", "r") as f:
            content = f.read().strip()
            if not content:
                raise ValueError("personas.json is empty")
            return json.loads(content)
    except (FileNotFoundError, json.JSONDecodeError, ValueError) as e:
        logging.warning(f"Error loading personas.json: {str(e)}. Using fallback personas.")
        return {
            "blind_screen_reader": {
                "label": "Blind user with screen reader",
                "description": "Navigates entirely using keyboard and screen reader software.",
                "prompt": """Simulate a blind user relying on a screen reader. Focus on:
                - Page title, landmarks, headings
                - Alt text issues
                - Unlabeled buttons/links
                - Dynamic content accessibility
                - Reading order/tab sequence
                Highlight frustrations and fixes."""
            },
            "low_vision_elderly": {
                "label": "Low-vision elderly person",
                "description": "Struggles with contrast, font size, and visual layout.",
                "prompt": """Simulate an elderly user with low vision. Evaluate:
                - Text readability (size, contrast)
                - Link/button visibility
                - Zoom behavior
                - Visual clarity/clutter
                Provide readability/usability feedback."""
            },
            "motor_impaired_keyboard": {
                "label": "Motor-impaired keyboard-only user",
                "description": "Cannot use a mouse, relies on keyboard for navigation.",
                "prompt": """Simulate a motor-impaired user using only keyboard. Assess:
                - Tab order
                - Focus indicators
                - Skip links
                - Interactive elements accessibility
                - Keyboard traps
                Report frustrations and usability."""
            },
            "color_blind": {
                "label": "Color blind user",
                "description": "Struggles with color contrasts and distinctions.",
                "prompt": """Simulate a user with deuteranopia (green-red color blindness). Focus on:
                - Color contrast ratios
                - Links/buttons distinguished by color
                - Charts/maps color issues
                - Text/background contrast
                Highlight issues and fixes."""
            }
        }

def simulate_experience(html, persona_key):
    personas = load_personas()
    if persona_key not in personas:
        return {"error": f"Unknown persona: {persona_key}"}
    persona = personas[persona_key]
    limit = 60000
    chunks = [html[i:i+3000] for i in range(0, len(html), 3000)] if len(html) > limit else [html[:limit]]
    if len(html) > limit:
        st.warning(f"HTML content chunked for simulation ({len(chunks)} chunks).")
    results = []
    progress = st.progress(0, text="Simulating experience...")
    try:
        client = OpenAI(api_key=os.getenv("OPENAI_API_KEY"))
        for i, chunk in enumerate(chunks):
            response = client.chat.completions.create(
                model="gpt-4o",
                messages=[
                    {"role": "system", "content": persona['prompt'] + "\n\nOutput in structured Markdown."},
                    {"role": "user", "content": chunk}
                ],
                temperature=0.5,
            )
            result = response.choices[0].message.content
            results.append(result)
            progress.progress((i + 1) / len(chunks))
            time.sleep(1)
        merged_result = "\n\n".join(results)
        if len(merged_result) > 2000:
            summary_prompt = "Summarize simulation: Top 5 issues and fixes."
            summary_response = client.chat.completions.create(
                model="gpt-4o",
                messages=[{"role": "user", "content": summary_prompt + "\n\n" + merged_result}],
                temperature=0.5,
                max_tokens=500
            )
            merged_result = summary_response.choices[0].message.content
        return merged_result
    except Exception as e:
        logging.error(f"[Simulation Error] {str(e)}")
        return {"error": "Failed to simulate experience. Try again or contact support."}

def demo_simulation(html):
    st.subheader("Persona Simulation Demo", help="Preview how users with disabilities experience your site")
    st.markdown("Explore accessibility challenges with our persona demos—upgrade for full AI-powered simulations!")
    personas = load_personas()
    selected_demo = st.selectbox(
        "Select Demo Persona",
        options=list(personas.keys()),
        format_func=lambda key: personas[key]["label"],
        help="Choose a persona to preview their experience",
        key="demo_persona_select"
    )
    if selected_demo:
        st.info(personas[selected_demo]["description"])
        if selected_demo == "blind_screen_reader":
            st.markdown("### Blind User Demo: Screen Reader Preview")
            soup = BeautifulSoup(html, 'html.parser')
            text = soup.get_text(separator=' ', strip=True)
            # Deduplicate and format
            lines = list(dict.fromkeys(text.splitlines()))
            formatted_text = "## Page Structure\n" + "\n".join(f"- {line}" for line in lines if line.strip())[:500] + "\n\n... (upgrade for full analysis)"
            with st.expander("Screen Reader Output Preview (click to expand)", expanded=False):
                st.markdown(formatted_text)
                st.markdown("**Example Issue**: Missing alt text on images makes content inaccessible to screen readers.")
                st.markdown("**Fix**: Add `alt='Description'` to `<img>` tags, e.g., `<img src='logo.png' alt='NASA logo'>`.")
            # Add TTS audio with options
            voice_speed = st.slider(
                "Mock Screen Reader Speed",
                0.5, 2.0, 1.0,
                help="Adjust how fast the screen reader speaks",
                key="tts_speed"
            )
            if st.button("Play Mock Screen Reader Audio", key="tts_button"):
                plain_text = " ".join(lines[:10])[:200]  # Use plain text, limit to 200 chars
                if plain_text.strip():
                    try:
                        tts = gTTS(plain_text, slow=(voice_speed < 1.0))
                        with tempfile.NamedTemporaryFile(suffix=".mp3", delete=False) as tmp_file:
                            tts.save(tmp_file.name)
                            with open(tmp_file.name, "rb") as f:
                                buffer = io.BytesIO(f.read())
                        buffer.seek(0)
                        st.audio(buffer, format="audio/mp3")
                        os.unlink(tmp_file.name)
                    except Exception as e:
                        logging.error(f"TTS Error: {str(e)}")
                        st.error("Audio generation failed—upgrade for full simulations!")
                else:
                    st.error("No text available for audio—upgrade for full simulations!")
            st.markdown("**Tip**: Screen readers read linearly—ensure clear headings and labels for accessibility (WCAG 1.3.1).")
        elif selected_demo == "low_vision_elderly":
            st.markdown("### Low-Vision Demo: High-Contrast Preview")
            st.markdown("<style> .low-vision-demo { font-size: 24px; color: #000; background: #fff; padding: 10px; } </style>", unsafe_allow_html=True)
            st.markdown("<div class='low-vision-demo'>" + html[:1000] + "... (upgrade for full)</div>", unsafe_allow_html=True)
            st.markdown("**Example Issue**: Low contrast text (e.g., gray on white) is hard to read.")
            st.markdown("**Fix**: Use high-contrast colors, e.g., black on white (WCAG 1.4.3).")
            st.markdown("**Tip**: Low-vision users need large text and high contrast—check WCAG 1.4.3.")
        elif selected_demo == "motor_impaired_keyboard":
            st.markdown("### Motor-Impaired Demo: Keyboard Navigation Preview")
            st.markdown("Focusable elements (e.g., links/buttons) would be highlighted for keyboard navigation.")
            st.markdown("**Example**: Links like 'Explore' or 'Search' should have visible focus indicators.")
            st.markdown("**Fix**: Add CSS like `a:focus { outline: 2px solid blue; }`.")
            st.markdown("**Tip**: Ensure all interactive elements are keyboard-accessible (WCAG 2.1.1).")
        elif selected_demo == "color_blind":
            st.markdown("### Color Blind Demo: Deuteranopia Preview")
            st.markdown("<style> .color-blind-demo { filter: grayscale(100%) hue-rotate(90deg); padding: 10px; } </style>", unsafe_allow_html=True)
            st.markdown("<div class='color-blind-demo'>" + html[:1000] + "... (upgrade for full)</div>", unsafe_allow_html=True)
            st.markdown("**Example Issue**: Red/green buttons look identical to color blind users.")
            st.markdown("**Fix**: Add icons or text labels, e.g., `<button>Submit ✓</button>`.")
            st.markdown("**Tip**: Color blind users may confuse red/green—use patterns or labels (WCAG 1.4.1).")
        st.markdown("**Why Upgrade?** Get full AI-powered simulations, code fixes, and exports to make your site accessible. Over 100 developers and agencies have upgraded!")
        st.markdown(
            """
            <style>
            .upgrade-button {
                background-color: #315b7c;
                color: white;
                padding: 10px 20px;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                font-size: 16px;
            }
            .upgrade-button:hover {
                background-color: #45a049;
            }
            </style>
            <a href='https://www.nexassistai.com/upgrade' class='upgrade-button'>Upgrade to Pro Now ($9/mo)</a>
            """,
            unsafe_allow_html=True
        )